<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>FlashChat Pro ‚Äî –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –Ω–æ–≤–æ–≥–æ –ø–æ–∫–æ–ª–µ–Ω–∏—è</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f172a;
      --panel2:#111827;
      --card:rgba(31,41,55,.6);
      --border:rgba(148,163,184,.15);
      --muted:#9ca3af;
      --text:#e5e7eb;
      --purple:#8b5cf6;
      --blue:#60a5fa;
    }

    *{ box-sizing:border-box; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; }

    /* Robust viewport height across mobile browsers */
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      overflow:hidden;
      height:100vh;
      height:100svh;
      height:100dvh;
    }

    .gradient-bg{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .gradient-green{ background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .gradient-orange{ background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }

    .glass{ background: rgba(255,255,255,.06); backdrop-filter: blur(14px); }

    /* App shell */
    #appShell{
      position:fixed;
      inset:0;
      display:flex;
      flex-direction:column;
      height:100vh;
      height:100svh;
      height:100dvh;
      overflow:hidden;
    }

    /* Auth screen scrollable */
    #authScreen{ position:absolute; inset:0; overflow:auto; -webkit-overflow-scrolling:touch; }

    /* Chat screen */
    #chatScreen{ position:absolute; inset:0; display:none; }
    #chatScreen.active{ display:flex; }

    /* Two-panel layout base */
    #sidebar{ width:100%; max-width:420px; min-width:320px; display:flex; flex-direction:column; height:100%; border-right:1px solid var(--border); background:rgba(15, 23, 42, .55); }
    #chatArea{ flex:1 1 auto; min-width:0; display:flex; flex-direction:column; height:100%; background:rgba(2,6,23,.35); }

    /* Mobile: single panel (Telegram-like) */
    @media (max-width: 768px){
      /* One panel at a time; both are full-screen, JS toggles display */
      #chatScreen.active{ display:block; }
      #sidebar, #chatArea{ position:absolute; inset:0; width:100%; max-width:none; min-width:0; height:100%; height:100svh; height:100dvh; }
      #sidebar{ display:flex; }
      #chatArea{ display:none; }
      #chatArea.active{ display:flex; }

      /* Make bubbles/media feel like TG on mobile */
      .bubble{ max-width: 88%; }
      .message-media img, .message-media video{ max-width: 300px; max-height: 420px; }
      #messagesContainer{ padding:12px; }
    }

    /* iOS Safari: prefer -webkit-fill-available when dvh is weird */
    @supports (height: -webkit-fill-available){
      body{ height: -webkit-fill-available; }
      #appShell{ height: -webkit-fill-available; }
    }

    /* TG-like caption spacing: media on top, caption below with comfortable leading */
    .bubble .text-sm{ line-height: 1.35; }

    /* Sidebar internals */
    #chatList{ flex:1 1 auto; min-height:0; overflow:auto; -webkit-overflow-scrolling:touch; }
    #searchResults{ max-height: 40vh; overflow:auto; }

    /* Chat area internals */
    #emptyChat{ flex:1 1 auto; display:flex; align-items:center; justify-content:center; padding:24px; }

    #activeChat{ flex:1 1 auto; min-height:0; display:none; flex-direction:column; overflow:hidden; }
    #activeChat.active{ display:flex; }

    .chat-header{ flex:0 0 auto; border-bottom:1px solid var(--border); background:rgba(15, 23, 42, .85); }

    #messagesContainer{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      padding:14px;
      padding-bottom:18px;
    }

    #typingIndicator{ flex:0 0 auto; }
    #uploadPreview{ flex:0 0 auto; }

    /* Input pinned */
    #messageInputArea{
      flex:0 0 auto;
      border-top:1px solid var(--border);
      background:rgba(15, 23, 42, .92);
      padding:10px;
      padding-bottom:max(10px, env(safe-area-inset-bottom));
    }

    #messageForm{ display:flex; align-items:center; gap:8px; }
    #messageInput{
      flex:1 1 auto;
      min-width:0;
      height:44px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(31,41,55,.5);
      color:white;
      padding:0 14px;
      font-size:14px;
      outline:none;
    }
    #messageInput:focus{ border-color: rgba(139,92,246,.9); box-shadow: 0 0 0 3px rgba(139,92,246,.15); }

    .icon-btn{
      width:44px; height:44px;
      display:grid; place-items:center;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(31,41,55,.25);
      color:#cbd5e1;
      flex:0 0 auto;
    }
    .icon-btn:hover{ background:rgba(31,41,55,.45); color:white; }

    .send-btn{
      width:44px; height:44px;
      display:grid; place-items:center;
      border-radius:14px;
      border:none;
      color:white;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 8px 20px rgba(102,126,234,.28);
      flex:0 0 auto;
    }
    .send-btn:hover{ opacity:.92; }

    /* Scrollbars */
    .scrollbar::-webkit-scrollbar{ width:7px; height:7px; }
    .scrollbar::-webkit-scrollbar-thumb{ background: rgba(148,163,184,.25); border-radius:999px; }
    .scrollbar::-webkit-scrollbar-track{ background: transparent; }

    /* Messages */
    .message-row{ display:flex; }
    .message-row.out{ justify-content:flex-end; }
    .message-row.in{ justify-content:flex-start; }

    .bubble{
      max-width:min(78ch, 78%);
      border-radius:18px;
      padding:10px 12px;
      position:relative;
      overflow:hidden;
    }
    .bubble.out{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-top-right-radius:6px; }
    .bubble.in{ background: rgba(31,41,55,.75); border-top-left-radius:6px; border:1px solid rgba(148,163,184,.12); }

    .sender-line{ font-size:12px; color: rgba(167,139,250, .95); margin: 0 0 6px 2px; display:flex; align-items:center; gap:6px; }

    .meta{ display:flex; justify-content:flex-end; align-items:center; gap:6px; margin-top:6px; }
    .meta .time{ font-size:11px; color: rgba(255,255,255,.75); }
    .bubble.in .meta .time{ color: rgba(148,163,184,.85); }

    /* TG-like media: never overflow, keep within bubble */
    .message-media{
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.45);
      display:inline-block;
      width: fit-content;
      max-width: 100%;
    }
    .message-media img, .message-media video{
      display:block;
      width:auto;
      max-width:360px;
      max-height:420px;
      height:auto;
      object-fit:contain;
      background:black;
    }

    /* Caption under media (Telegram-like) */
    .media-caption{ margin-top: 6px; }

    .file-chip{ display:flex; align-items:center; gap:10px; padding:10px; border-radius:14px; background:rgba(15,23,42,.45); border:1px solid rgba(148,163,184,.15); }

    /* Typing indicator */
    .typing-dot{ width:7px; height:7px; background:rgba(148,163,184,.9); border-radius:999px; display:inline-block; animation:typing 1.2s infinite; }
    .typing-dot:nth-child(2){ animation-delay:.15s; }
    .typing-dot:nth-child(3){ animation-delay:.3s; }
    @keyframes typing{ 0%,60%,100%{ transform:translateY(0); opacity:.7 } 30%{ transform:translateY(-4px); opacity:1 } }

    /* Toast */
    #toast{ position:fixed; top:14px; left:14px; right:14px; max-width:520px; margin:0 auto; z-index:80; }

    /* Modals */
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:16px; z-index:70; background:rgba(0,0,0,.65); backdrop-filter: blur(6px); }
    .modal.show{ display:flex; }
    .sheet{ width:100%; max-width:520px; border-radius:22px; border:1px solid rgba(148,163,184,.18); background:rgba(15,23,42,.92); box-shadow: 0 18px 60px rgba(0,0,0,.45); overflow:hidden; }

    @media (max-width:768px){
      .sheet{ max-width: 100%; border-radius: 22px; }
      .sheet.bottom{ align-self:flex-end; border-bottom-left-radius:0; border-bottom-right-radius:0; }
    }

    /* Emoji picker */
    #emojiPicker{ display:none; margin-top:10px; border-radius:16px; border:1px solid rgba(148,163,184,.15); overflow:hidden; background:rgba(15,23,42,.85); }
    #emojiPicker.show{ display:block; }
    .emoji-tabs{ display:flex; border-bottom:1px solid rgba(148,163,184,.12); }
    .emoji-tab{ flex:1; padding:10px 0; text-align:center; font-size:18px; color:#cbd5e1; border-bottom:2px solid transparent; background:rgba(2,6,23,.18); }
    .emoji-tab.active{ border-bottom-color: rgba(139,92,246,.9); color:white; }
    .emoji-grid{ padding:10px; max-height:220px; overflow:auto; display:grid; grid-template-columns: repeat(8, minmax(0,1fr)); gap:6px; }
    .emoji-btn{ border-radius:10px; padding:6px 0; font-size:20px; line-height:1; }
    .emoji-btn:hover{ background:rgba(148,163,184,.12); }

    /* Developer badge */
    .dev-badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 7px;
      border-radius:999px;
      font-size:10px;
      font-weight:700;
      letter-spacing:.6px;
      color:white;
      background: linear-gradient(135deg,#f093fb 0%, #f5576c 100%);
      border:1px solid rgba(255,255,255,.18);
      vertical-align:middle;
      white-space:nowrap;
    }
    .dev-badge svg{ width:12px; height:12px; }

    /* Reaction picker */
    #reactionsPicker{ position:fixed; display:none; z-index:75; padding:8px; border-radius:16px; background:rgba(15,23,42,.92); border:1px solid rgba(148,163,184,.18); box-shadow: 0 14px 40px rgba(0,0,0,.45); }
    #reactionsPicker.show{ display:block; }
    .reaction-btn{ font-size:22px; padding:6px; border-radius:12px; }
    .reaction-btn:hover{ background:rgba(148,163,184,.12); transform:scale(1.08); }

    /* Image viewer */
    #imageViewer{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:90; background:rgba(0,0,0,.9); padding:16px; }
    #imageViewer.show{ display:flex; }

    /* Small helpers */
    .fade-in{ animation: fade .18s ease; }
    @keyframes fade{ from{ opacity:0; transform: translateY(8px);} to{ opacity:1; transform: translateY(0);} }
  </style>
</head>
<body>
  <div id="appShell">

    <!-- AUTH -->
    <div id="authScreen" class="px-4 py-10">
      <div class="mx-auto w-full max-w-md">
        <div class="text-center mb-8">
          <div class="w-20 h-20 gradient-bg rounded-2xl mx-auto mb-4 flex items-center justify-center shadow-lg">
            <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
          </div>
          <h1 class="text-3xl font-bold">FlashChat Pro</h1>
          <p class="text-slate-400 mt-2">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –Ω–æ–≤–æ–≥–æ –ø–æ–∫–æ–ª–µ–Ω–∏—è</p>
        </div>

        <div id="savedAccounts" class="hidden mb-4">
          <p class="text-sm text-slate-400 mb-2">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã:</p>
          <div id="accountsList" class="space-y-2 max-h-40 overflow-auto scrollbar"></div>
        </div>

        <div class="glass rounded-3xl p-6 border" style="border-color: var(--border)">
          <div class="flex mb-6 bg-white/5 rounded-xl p-1">
            <button id="loginTab" class="flex-1 py-2 px-4 rounded-lg font-medium transition-all bg-violet-600 text-white" onclick="showTab('login')">–í—Ö–æ–¥</button>
            <button id="registerTab" class="flex-1 py-2 px-4 rounded-lg font-medium transition-all text-slate-400" onclick="showTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
          </div>

          <form id="loginForm" class="space-y-4" onsubmit="login(event)">
            <input type="email" id="loginEmail" required placeholder="Email" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500">
            <input type="password" id="loginPassword" required placeholder="–ü–∞—Ä–æ–ª—å" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500">
            <label class="flex items-center gap-2 text-sm text-slate-400">
              <input type="checkbox" id="saveAccount" checked>
              <span>–ó–∞–ø–æ–º–Ω–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</span>
            </label>
            <button type="submit" class="w-full gradient-bg py-3 rounded-xl font-semibold hover:opacity-95">–í–æ–π—Ç–∏</button>
          </form>

          <form id="registerForm" class="space-y-4 hidden" onsubmit="register(event)">
            <input type="text" id="registerName" required placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500">
            <input type="email" id="registerEmail" required placeholder="Email" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500">
            <input type="password" id="registerPassword" required minlength="6" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500">
            <button type="submit" class="w-full gradient-bg py-3 rounded-xl font-semibold hover:opacity-95">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
          </form>

          <div id="authError" class="mt-4 text-red-300 text-sm text-center hidden"></div>
        </div>
      </div>
    </div>

    <!-- CHAT -->
    <div id="chatScreen">
      <!-- Sidebar -->
      <aside id="sidebar" class="safe-top">
        <div class="p-3 border-b" style="border-color: var(--border)">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-xl font-bold">FlashChat</h2>
            <div class="flex gap-1">
              <button class="icon-btn" title="–°–æ–∑–¥–∞—Ç—å" onclick="showCreateMenu()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
              </button>
              <button class="icon-btn" title="–ê–∫–∫–∞—É–Ω—Ç—ã" onclick="showAccountSwitcher()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
              </button>
              <button class="icon-btn" title="–ü—Ä–æ—Ñ–∏–ª—å" onclick="showProfile()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
              </button>
            </div>
          </div>

          <div class="flex gap-1 mb-3 bg-white/5 rounded-xl p-1">
            <button id="tabAll" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium bg-violet-600" onclick="showChatTab('all')">–í—Å–µ</button>
            <button id="tabPrivate" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium text-slate-400" onclick="showChatTab('private')">–õ–∏—á–Ω—ã–µ</button>
            <button id="tabGroups" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium text-slate-400" onclick="showChatTab('groups')">–ì—Ä—É–ø–ø—ã</button>
            <button id="tabChannels" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium text-slate-400" onclick="showChatTab('channels')">–ö–∞–Ω–∞–ª—ã</button>
          </div>

          <div class="relative">
            <input id="searchInput" oninput="searchAll()" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 pl-10 outline-none focus:border-violet-500 text-sm" placeholder="–ü–æ–∏—Å–∫...">
            <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
          </div>
        </div>

        <div id="searchResults" class="hidden border-b" style="border-color: var(--border)"></div>
        <div id="chatList" class="scrollbar"></div>
      </aside>

      <!-- Chat Area -->
      <main id="chatArea">
        <div id="emptyChat">
          <div class="text-center">
            <div class="w-24 h-24 bg-white/5 rounded-full mx-auto mb-4 grid place-items-center">
              <svg class="w-12 h-12 text-slate-500" fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
            </div>
            <h3 class="text-xl font-semibold text-slate-300">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
            <p class="text-slate-500 mt-2">–∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π</p>
          </div>
        </div>

        <section id="activeChat">
          <div class="chat-header p-3 flex items-center gap-3">
            <button class="icon-btn md:hidden" onclick="closeChat()" title="–ù–∞–∑–∞–¥">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            </button>
            <div id="chatAvatar" class="w-10 h-10 rounded-full gradient-bg flex items-center justify-center font-bold flex-shrink-0"></div>
            <div class="flex-1 min-w-0">
              <h3 id="chatName" class="font-semibold truncate"></h3>
              <p id="chatStatus" class="text-xs text-slate-400 truncate"></p>
            </div>
            <div id="chatHeaderActions" class="flex gap-1 flex-shrink-0"></div>
          </div>

          <div id="messagesContainer" class="scrollbar"></div>

          <div id="typingIndicator" class="hidden px-4 py-2">
            <div class="flex items-center gap-2 text-slate-400 text-sm">
              <div class="flex gap-1">
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
              </div>
              <span id="typingText">–ø–µ—á–∞—Ç–∞–µ—Ç...</span>
            </div>
          </div>

          <!-- Upload preview with caption + send -->
          <div id="uploadPreview" class="hidden px-3 py-3 border-t" style="border-color: var(--border); background: rgba(15,23,42,.9)">
            <div class="flex flex-col gap-2">
              <div class="flex items-start gap-3">
                <img id="uploadPreviewImage" src="" class="w-20 h-20 object-contain rounded-xl hidden" style="background: rgba(2,6,23,.55)" alt="preview">
                <div id="uploadPreviewFile" class="hidden items-center gap-2 p-2 bg-white/5 rounded-xl border border-white/10">
                  <svg class="w-8 h-8 text-violet-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                  <span id="uploadFileName" class="text-sm truncate max-w-[180px]"></span>
                </div>
                <div class="flex-1 min-w-0 flex flex-col gap-2">
                  <input id="imageCaption" class="w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm outline-none focus:border-violet-500" placeholder="–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å—å..." />
                  <div id="uploadProgress" class="h-2 bg-white/10 rounded-full overflow-hidden hidden">
                    <div id="uploadProgressBar" class="h-full gradient-bg" style="width:0%"></div>
                  </div>
                </div>
                <button class="icon-btn" onclick="cancelUpload()" title="–û—Ç–º–µ–Ω–∞">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
              </div>
              <button class="w-full gradient-bg py-2.5 rounded-xl font-semibold hover:opacity-95" onclick="sendFileWithCaption()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
          </div>

          <div id="messageInputArea">
            <form id="messageForm" onsubmit="sendMessage(event)">
              <input type="file" id="fileInput" class="hidden" accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.zip,.rar,.ppt,.pptx,.txt" onchange="handleFileSelect(event)">
              <button type="button" class="icon-btn" onclick="openFilePicker()" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
              </button>
              <button type="button" class="icon-btn" onclick="toggleEmoji()" title="–≠–º–æ–¥–∑–∏">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              </button>
              <input id="messageInput" type="text" autocomplete="off" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." oninput="handleTyping()">
              <button class="send-btn" type="submit" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
              </button>
            </form>

            <div id="emojiPicker">
              <div class="emoji-tabs">
                <button type="button" class="emoji-tab active" id="emojiTabSmileys" onclick="showEmojiCategory('smileys')">üòÄ</button>
                <button type="button" class="emoji-tab" id="emojiTabGestures" onclick="showEmojiCategory('gestures')">üëã</button>
                <button type="button" class="emoji-tab" id="emojiTabAnimals" onclick="showEmojiCategory('animals')">üê±</button>
                <button type="button" class="emoji-tab" id="emojiTabFood" onclick="showEmojiCategory('food')">üçï</button>
                <button type="button" class="emoji-tab" id="emojiTabActivities" onclick="showEmojiCategory('activities')">‚öΩ</button>
                <button type="button" class="emoji-tab" id="emojiTabTravel" onclick="showEmojiCategory('travel')">üöó</button>
                <button type="button" class="emoji-tab" id="emojiTabObjects" onclick="showEmojiCategory('objects')">üí°</button>
                <button type="button" class="emoji-tab" id="emojiTabSymbols" onclick="showEmojiCategory('symbols')">‚ù§Ô∏è</button>
              </div>
              <div id="emojiGrid" class="emoji-grid scrollbar"></div>
            </div>
          </div>

          <div id="channelNotice" class="px-4 py-4 text-center text-slate-400" style="display:none; border-top:1px solid var(--border); background:rgba(15,23,42,.9)">
            <svg class="w-6 h-6 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg>
            –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å –≤ —ç—Ç–æ—Ç –∫–∞–Ω–∞–ª
          </div>
        </section>
      </main>
    </div>

    <!-- Toast -->
    <div id="toast" class="hidden" onclick="handleToastClick()">
      <div class="glass border" style="border-color:var(--border); border-radius:16px; padding:12px 14px; cursor:pointer;">
        <div class="flex items-center gap-3">
          <div id="toastIcon" class="w-10 h-10 rounded-full gradient-bg grid place-items-center font-bold shrink-0"></div>
          <div class="min-w-0">
            <div id="toastTitle" class="font-semibold truncate"></div>
            <div id="toastMessage" class="text-sm text-slate-400 truncate"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Reactions Picker -->
    <div id="reactionsPicker" class="fade-in">
      <div class="flex gap-1">
        <button class="reaction-btn" onclick="addReaction('üëç')">üëç</button>
        <button class="reaction-btn" onclick="addReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
        <button class="reaction-btn" onclick="addReaction('üòÇ')">üòÇ</button>
        <button class="reaction-btn" onclick="addReaction('üòÆ')">üòÆ</button>
        <button class="reaction-btn" onclick="addReaction('üò¢')">üò¢</button>
        <button class="reaction-btn" onclick="addReaction('üî•')">üî•</button>
      </div>
    </div>

    <!-- Image Viewer -->
    <div id="imageViewer" onclick="closeImageViewer()">
      <button class="absolute top-4 right-4 icon-btn" style="background: rgba(255,255,255,.1); border-color: rgba(255,255,255,.18)">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
      <img id="viewerImage" alt="view" class="max-w-full max-h-full object-contain" />
    </div>

    <!-- Create Menu Modal -->
    <div id="createMenuModal" class="modal" onclick="modalBackdropClose(event, 'createMenuModal')">
      <div class="sheet bottom p-4">
        <h3 class="text-lg font-bold mb-4 text-center">–°–æ–∑–¥–∞—Ç—å</h3>
        <div class="space-y-2">
          <button class="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl" onclick="showNewPrivateChat()">
            <div class="w-10 h-10 gradient-bg rounded-full grid place-items-center">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
            </div>
            <div class="text-left">
              <div class="font-medium">–õ–∏—á–Ω—ã–π —á–∞—Ç</div>
              <div class="text-xs text-slate-400">–ù–∞–ø–∏—Å–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</div>
            </div>
          </button>

          <button class="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl" onclick="showCreateGroup()">
            <div class="w-10 h-10 gradient-green rounded-full grid place-items-center">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
            </div>
            <div class="text-left">
              <div class="font-medium">–ì—Ä—É–ø–ø–∞</div>
              <div class="text-xs text-slate-400">–î–æ 200 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
            </div>
          </button>

          <button class="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl" onclick="showCreateChannel()">
            <div class="w-10 h-10 gradient-orange rounded-full grid place-items-center">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg>
            </div>
            <div class="text-left">
              <div class="font-medium">–ö–∞–Ω–∞–ª</div>
              <div class="text-xs text-slate-400">–¢–æ–ª—å–∫–æ –≤—ã –º–æ–∂–µ—Ç–µ –ø–∏—Å–∞—Ç—å</div>
            </div>
          </button>
        </div>
        <button class="w-full mt-4 py-2 text-slate-400 hover:text-white" onclick="closeModal('createMenuModal')">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>

    <!-- New Private Chat Modal -->
    <div id="newPrivateChatModal" class="modal" onclick="modalBackdropClose(event, 'newPrivateChatModal')">
      <div class="sheet p-4 max-h-[80vh] flex flex-col">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold">–ù–æ–≤—ã–π —á–∞—Ç</h3>
          <button class="icon-btn" onclick="closeModal('newPrivateChatModal')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <input id="userSearchInput" oninput="searchUsersForChat()" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 mb-3 outline-none focus:border-violet-500" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...">
        <div id="userSearchResults" class="flex-1 overflow-auto scrollbar"></div>
      </div>
    </div>

    <!-- Create Group Modal -->
    <div id="createGroupModal" class="modal" onclick="modalBackdropClose(event, 'createGroupModal')">
      <div class="sheet p-4 max-h-[86vh] flex flex-col">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold">–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞</h3>
          <button class="icon-btn" onclick="closeModal('createGroupModal')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <input id="groupName" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 mb-3 outline-none focus:border-violet-500" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
        <input id="groupSearchInput" oninput="searchUsersForGroup()" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 mb-3 outline-none focus:border-violet-500" placeholder="–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤...">
        <div id="selectedMembers" class="flex flex-wrap gap-2 mb-3"></div>
        <div id="groupSearchResults" class="flex-1 overflow-auto scrollbar mb-3 min-h-[200px]"></div>
        <button class="w-full gradient-bg py-2.5 rounded-xl font-semibold hover:opacity-95" onclick="createGroup()">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
      </div>
    </div>

    <!-- Create Channel Modal -->
    <div id="createChannelModal" class="modal" onclick="modalBackdropClose(event, 'createChannelModal')">
      <div class="sheet p-4">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold">–ù–æ–≤—ã–π –∫–∞–Ω–∞–ª</h3>
          <button class="icon-btn" onclick="closeModal('createChannelModal')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <input id="channelName" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 mb-3 outline-none focus:border-violet-500" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞">
        <textarea id="channelDescription" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 mb-3 outline-none focus:border-violet-500 resize-none h-24" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
        <button class="w-full gradient-bg py-2.5 rounded-xl font-semibold hover:opacity-95" onclick="createChannel()">–°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª</button>
      </div>
    </div>

    <!-- Account Switcher Modal -->
    <div id="accountSwitcherModal" class="modal" onclick="modalBackdropClose(event, 'accountSwitcherModal')">
      <div class="sheet bottom p-4">
        <h3 class="text-lg font-bold mb-4">–ê–∫–∫–∞—É–Ω—Ç—ã</h3>
        <div id="accountSwitcherList" class="space-y-2 max-h-64 overflow-auto scrollbar mb-4"></div>
        <button class="w-full flex items-center justify-center gap-2 p-3 border border-dashed border-white/20 rounded-xl text-slate-400 hover:border-violet-500 hover:text-violet-300" onclick="addNewAccount()">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
          –î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
        </button>
        <button class="w-full mt-3 py-2 text-slate-400 hover:text-white" onclick="closeModal('accountSwitcherModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal" onclick="modalBackdropClose(event, 'profileModal')">
      <div class="sheet p-6">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-bold">–ü—Ä–æ—Ñ–∏–ª—å</h3>
          <button class="icon-btn" onclick="closeModal('profileModal')">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <div class="text-center mb-6">
          <div id="profileAvatar" class="w-24 h-24 gradient-bg rounded-full mx-auto mb-4 grid place-items-center text-3xl font-bold"></div>
          <div id="profileNameDisplay" class="text-xl font-semibold"></div>
          <div id="profileEmail" class="text-slate-400"></div>
        </div>
        <form class="space-y-4" onsubmit="updateProfile(event)">
          <input id="newProfileName" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500" placeholder="–ù–æ–≤–æ–µ –∏–º—è">
          <input id="newProfileStatus" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500" placeholder="–°—Ç–∞—Ç—É—Å">
          <button type="submit" class="w-full gradient-bg py-3 rounded-xl font-semibold hover:opacity-95">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
        <button class="w-full mt-3 py-3 bg-red-500/15 text-red-300 rounded-xl font-medium hover:bg-red-500/25" onclick="logout()">–í—ã–π—Ç–∏</button>
      </div>
    </div>

    <!-- Settings Modal (group/channel) -->
    <div id="settingsModal" class="modal" onclick="modalBackdropClose(event, 'settingsModal')">
      <div class="sheet p-6 max-h-[90vh] overflow-auto scrollbar">
        <div class="flex justify-between items-center mb-6">
          <h3 id="settingsTitle" class="text-xl font-bold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
          <button class="icon-btn" onclick="closeModal('settingsModal')">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm text-slate-400 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input id="settingsName" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500">
          </div>

          <div id="settingsDescriptionBlock">
            <label class="block text-sm text-slate-400 mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea id="settingsDescription" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-violet-500 resize-none h-24"></textarea>
          </div>

          <div id="settingsMembersBlock">
            <label class="block text-sm text-slate-400 mb-2">–£—á–∞—Å—Ç–Ω–∏–∫–∏ (<span id="settingsMemberCount">0</span>)</label>
            <div id="settingsMembersList" class="space-y-2 max-h-56 overflow-auto scrollbar"></div>
          </div>

          <button class="w-full gradient-bg py-3 rounded-xl font-semibold hover:opacity-95" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="w-full py-3 bg-red-500/15 text-red-300 rounded-xl font-medium hover:bg-red-500/25" onclick="deleteGroupOrChannel()"><span id="deleteButtonText">–£–¥–∞–ª–∏—Ç—å</span></button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // ====== CONFIG ======
    const IMGBB_API_KEY = 'f457bea1a8c6cf16c4a03634c8ea3177';

    const DEVELOPER_EMAILS = [
      'stepanu142z@gmail.com',
      'Stepan42z@yandex.ru'
    ];

    function isDeveloper(email){
      if(!email) return false;
      return DEVELOPER_EMAILS.some(e => e.toLowerCase() === String(email).toLowerCase());
    }

    function getDevBadgeHtml(){
      return `<span class="dev-badge"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg>DEV</span>`;
    }

    function getNameWithBadge(name, email){
      const safeName = escapeHtml(name || '');
      return isDeveloper(email) ? safeName + ' ' + getDevBadgeHtml() : safeName;
    }

    const firebaseConfig = {
      apiKey: "AIzaSyBeLAiCwZjij3d6FZ4OzylJnaxPwlyf1Ag",
      authDomain: "webchat-28b64.firebaseapp.com",
      databaseURL: "https://webchat-28b64-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "webchat-28b64",
      storageBucket: "webchat-28b64.firebasestorage.app",
      messagingSenderId: "307131215178",
      appId: "1:307131215178:web:0e510297256e30959825b3",
      measurementId: "G-JD21B447LF"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();
    const storage = firebase.storage();

    // ====== STATE ======
    let currentUser = null;
    let currentUserData = null;
    let currentChat = null;
    let currentChatType = null;
    let currentChatData = null;
    let typingTimeout = null;
    let unreadCounts = {};
    let selectedGroupMembers = [];
    let currentMessageId = null;
    let currentTab = 'all';
    let allChats = [];
    let allUsers = {};
    let toastChatId = null;
    let pendingFile = null;
    let uploadTask = null;
    let isUploading = false;

    // ====== EMOJI DATA (large, TG-like categories) ======
    const EMOJI = {
      smileys: "üòÄ üòÉ üòÑ üòÅ üòÜ üòÖ üòÇ ü§£ üòä üòá üôÇ üôÉ üòâ üòå üòç ü•∞ üòò üòó üòô üòö üòã üòõ üòù üòú ü§™ ü§® üßê ü§ì üòé ü•∏ ü§© ü•≥ üòè üòí üòû üòî üòü üòï üôÅ ‚òπÔ∏è üò£ üòñ üò´ üò© ü•∫ üò¢ üò≠ üò§ üò† üò° ü§¨ üò≥ ü•µ ü•∂ üò± üò® üò∞ üò• üòì ü§ó ü§≠ ü§´ ü§î ü§ê üòê üòë üò∂ ü´• üò¨ üôÑ üòØ üò¶ üòß üòÆ üò≤ ü•± üò¥ ü§§ üò™ üòµ ü§Ø ü§† ü•¥ ü§Æ ü§¢ ü§ß ü§í ü§ï ü´† ü´°".split(" "),
      gestures: "üëã ü§ö üñêÔ∏è ‚úã üññ üëå ü§å ü§è ‚úåÔ∏è ü§û ü§ü ü§ò ü§ô ü´µ üëà üëâ üëÜ üñï üëá ‚òùÔ∏è üëç üëé ‚úä üëä ü§õ ü§ú üëè üôå üëê ü§≤ ü§ù üôè ‚úçÔ∏è üíÖ ü§≥ üí™ ü¶æ ü¶ø ü¶µ ü¶∂ üëÇ ü¶ª üëÉ üß† ü´Ä ü´Å üëÄ üëÅÔ∏è üëÖ üëÑ üíã".split(" "),
      animals: "üê∂ üê± üê≠ üêπ üê∞ ü¶ä üêª üêº üêª‚Äç‚ùÑÔ∏è üê® üêØ ü¶Å üêÆ üê∑ üêΩ üê∏ üêµ üôà üôâ üôä üêí üêî üêß üê¶ üê§ üê£ üê• ü¶Ü ü¶Ö ü¶â ü¶á üê∫ üêó üê¥ ü¶Ñ üêù ü™≤ üêõ ü¶ã üêå üêû üêú ü¶ü ü™∞ ü™± üê¢ üêç ü¶é üêô ü¶ë ü¶ê ü¶û ü¶Ä üê° üê† üêü üê¨ üê≥ üêã ü¶à üêä".split(" "),
      food: "üçè üçé üçê üçä üçã üçå üçâ üçá üçì ü´ê üçà üçí üçë ü•≠ üçç ü•• ü•ù üçÖ ü•ë üçÜ ü•î ü•ï üåΩ üå∂Ô∏è ü´ë ü•í ü•¨ ü•¶ üßÑ üßÖ üçÑ ü•ú ü´ò üå∞ üçû ü•ê ü•ñ ü´ì ü•® üßÄ ü•ö üç≥ üßà ü•û üßá ü•ì ü•© üçó üçñ üå≠ üçî üçü üçï ü•™ ü•ô üßÜ üåÆ üåØ ü•ó ü•ò üçù üçú üç≤ üçõ üç£ üç± üçô üçö üçò üç• ü•ü ü•† ü•° üç¢ üç° üçß üç® üç¶ ü•ß üßÅ üç∞ üéÇ üçÆ üç≠ üç¨ üç´ üçø üç© üç™ ‚òï üçµ üßÉ ü•§ üßã üç∫ üçª ü•Ç üç∑ üç∏ üçπ üßâ".split(" "),
      activities: "‚öΩ üèÄ üèà ‚öæ ü•é üéæ üèê üèâ ü•è üé± ü™Ä üèì üè∏ üèí üèë ü•ç üèè ‚õ≥ ü™Å üèπ üé£ ü§ø ü•ä ü•ã üéΩ üõπ üõ∑ ‚õ∏Ô∏è ü•å üéø ‚õ∑Ô∏è üèÇ üèãÔ∏è ü§º ü§∏ ‚õπÔ∏è ü§∫ üèá üßò üèÑ üèä üö¥ üöµ üßó üé™ üé≠ üé® üé¨ üé§ üéß üéº üéπ ü•Å üé∑ üé∫ üé∏ üéª üé≤ ‚ôüÔ∏è üéØ üé≥ üéÆ üïπÔ∏è üé∞ üß©".split(" "),
      travel: "üöó üöï üöô üöå üöé üèéÔ∏è üöì üöë üöí üöê üõª üöö üöõ üöú üèçÔ∏è üõµ üö≤ üõ¥ üöÅ ‚úàÔ∏è üõ©Ô∏è üöÄ üõ∏ üö¢ ‚õµ üö§ üõ•Ô∏è üöÇ üöÉ üöÑ üöÖ üöÜ üöá üöà üöâ üó∫Ô∏è üß≠ üèîÔ∏è ‚õ∞Ô∏è üåã üóª üèïÔ∏è üèñÔ∏è üèúÔ∏è üèùÔ∏è üèüÔ∏è üèõÔ∏è üèóÔ∏è üß± üè† üè° üè¢ üè£ üè• üè¶ üè® üè© üè™ üè´ üè¨ üè≠ üóº üóΩ ‚õ™ üïå üõï ‚õ©Ô∏è üåâ üåå üå†".split(" "),
      objects: "‚åö üì± üíª ‚å®Ô∏è üñ•Ô∏è üñ®Ô∏è üñ±Ô∏è üñ≤Ô∏è üíΩ üíæ üíø üìÄ üì∑ üì∏ üìπ üé• üìΩÔ∏è üì∫ üìª üéôÔ∏è üéöÔ∏è üéõÔ∏è üìû ‚òéÔ∏è üìü üì† üîã üîå üí° üî¶ üïØÔ∏è ü™î üßØ üõ¢Ô∏è üí∏ üíµ üí¥ üí∂ üí∑ üí∞ üí≥ üíé ‚öñÔ∏è üîß üî® ‚öíÔ∏è üõ†Ô∏è ‚õèÔ∏è ü™ì üî© ‚öôÔ∏è üóúÔ∏è üîó ‚õìÔ∏è üß∞ üß≤ üîí üîì üîë üóùÔ∏è üîê üß≥ üì¶ üì´ üì¨ üì≠ üìÆ ‚úâÔ∏è üìß üì® üìù üìÅ üìÇ üóÇÔ∏è üìÖ üìÜ üìä üìà üìâ üìã üìå üìç".split(" "),
      symbols: "‚ù§Ô∏è üß° üíõ üíö üíô üíú üñ§ ü§ç ü§é üíî ‚ù£Ô∏è üíï üíû üíì üíó üíñ üíò üíù üíü ‚òÆÔ∏è ‚úùÔ∏è ‚ò™Ô∏è üïâÔ∏è ‚òØÔ∏è ‚ú°Ô∏è üîØ ‚ôà ‚ôâ ‚ôä ‚ôã ‚ôå ‚ôç ‚ôé ‚ôè ‚ôê ‚ôë ‚ôí ‚ôì ‚õé üîÄ üîÅ üîÇ ‚ñ∂Ô∏è ‚è© ‚è≠Ô∏è ‚èØÔ∏è ‚óÄÔ∏è ‚è™ üîº ‚è´ üîΩ ‚è¨ ‚è∏Ô∏è ‚èπÔ∏è ‚è∫Ô∏è üîÜ üîÖ üì∂ üì≥ üì¥ ‚úñÔ∏è ‚ûï ‚ûñ ‚ûó ‚ôæÔ∏è üí≤ üí± ‚Ñ¢Ô∏è ¬©Ô∏è ¬ÆÔ∏è „Ä∞Ô∏è ‚û∞ ‚ûø ‚úîÔ∏è ‚òëÔ∏è üîò üî¥ üü† üü° üü¢ üîµ üü£ ‚ö´ ‚ö™ üü§ üî∫ üîª üî∏ üîπ üî∂ üî∑ üî≥ üî≤ ‚ñ™Ô∏è ‚ñ´Ô∏è ‚óæ ‚óΩ ‚¨õ ‚¨ú üîî üîï üîä üîá üí¨ üí≠ üóØÔ∏è üî• ‚ú® üéâ üíØ ‚≠ê üåü üí´ ‚ö° üí• üéä üéÅ üèÜ ü•á ü•à ü•â üèÖ üéñÔ∏è üéóÔ∏è".split(" ")
    };

    // ====== UI HELPERS ======
    function $(id){ return document.getElementById(id); }

    function showModal(id){ $(id).classList.add('show'); }
    function closeModal(id){ $(id).classList.remove('show'); }

    function modalBackdropClose(e, id){
      if(e.target && e.target.id === id) closeModal(id);
    }

    function showToast(icon, title, msg, chatId=null){
      toastChatId = chatId;
      $('toastIcon').textContent = icon;
      $('toastTitle').textContent = title;
      $('toastMessage').textContent = msg;
      const t = $('toast');
      t.classList.remove('hidden');
      clearTimeout(t._timer);
      t._timer = setTimeout(()=> t.classList.add('hidden'), 4000);
    }

    function handleToastClick(){
      $('toast').classList.add('hidden');
      if(toastChatId){
        const chat = allChats.find(c => c.id === toastChatId);
        if(chat) openChat(toastChatId, chat.type);
      }
    }

    function escapeHtml(text){
      const div = document.createElement('div');
      div.textContent = text ?? '';
      return div.innerHTML;
    }

    function formatTime(ts){
      if(!ts) return '';
      const d = new Date(ts);
      const now = new Date();
      if(d.toDateString() === now.toDateString()){
        return d.toLocaleTimeString('ru-RU',{hour:'2-digit', minute:'2-digit'});
      }
      return d.toLocaleDateString('ru-RU',{day:'numeric', month:'short'});
    }

    function formatLastSeen(ts){
      if(!ts) return '–¥–∞–≤–Ω–æ';
      const diff = Date.now() - ts;
      if(diff < 60000) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
      if(diff < 3600000) return `${Math.floor(diff/60000)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
      if(diff < 86400000) return `${Math.floor(diff/3600000)} —á –Ω–∞–∑–∞–¥`;
      return new Date(ts).toLocaleDateString('ru-RU');
    }

    // ====== AUTH UI ======
    function showTab(tab){
      $('loginForm').classList.toggle('hidden', tab !== 'login');
      $('registerForm').classList.toggle('hidden', tab !== 'register');
      $('loginTab').classList.toggle('bg-violet-600', tab === 'login');
      $('loginTab').classList.toggle('text-white', tab === 'login');
      $('loginTab').classList.toggle('text-slate-400', tab !== 'login');
      $('registerTab').classList.toggle('bg-violet-600', tab === 'register');
      $('registerTab').classList.toggle('text-white', tab === 'register');
      $('registerTab').classList.toggle('text-slate-400', tab !== 'register');
    }

    function getErrorMessage(code){
      const messages = {
        'auth/email-already-in-use': 'Email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è',
        'auth/invalid-email': '–ù–µ–≤–µ—Ä–Ω—ã–π email',
        'auth/weak-password': '–°–ª–∞–±—ã–π –ø–∞—Ä–æ–ª—å',
        'auth/user-not-found': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω',
        'auth/wrong-password': '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å'
      };
      return messages[code] || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏';
    }

    function showAuthError(msg){
      const el = $('authError');
      el.textContent = msg;
      el.classList.remove('hidden');
      clearTimeout(el._timer);
      el._timer = setTimeout(()=> el.classList.add('hidden'), 4000);
    }

    // Accounts storage
    function loadSavedAccounts(){
      const accounts = JSON.parse(localStorage.getItem('flashchat_accounts') || '[]');
      const container = $('savedAccounts');
      const list = $('accountsList');

      if(accounts.length){
        container.classList.remove('hidden');
        list.innerHTML = accounts.map(acc => `
          <div class="flex items-center gap-3 p-2 rounded-xl bg-white/5 border border-white/10">
            <div class="w-8 h-8 gradient-bg rounded-full grid place-items-center font-bold text-sm">${escapeHtml((acc.name||'?').charAt(0).toUpperCase())}</div>
            <div class="flex-1 min-w-0">
              <div class="font-medium text-sm truncate">${escapeHtml(acc.name||acc.email)}</div>
              <div class="text-xs text-slate-400 truncate">${escapeHtml(acc.email)}</div>
            </div>
            <button class="text-xs bg-violet-600 px-2 py-1 rounded-lg" onclick="quickLogin('${escapeHtml(acc.email)}','${escapeHtml(acc.password)}')">–í–æ–π—Ç–∏</button>
            <button class="text-slate-400 hover:text-red-300 p-1" onclick="removeAccount('${escapeHtml(acc.email)}')">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
        `).join('');
      } else {
        container.classList.add('hidden');
        list.innerHTML = '';
      }
    }

    function saveAccount(email,password,name){
      let accounts = JSON.parse(localStorage.getItem('flashchat_accounts') || '[]');
      accounts = accounts.filter(a => a.email !== email);
      accounts.unshift({email,password,name});
      if(accounts.length > 5) accounts = accounts.slice(0,5);
      localStorage.setItem('flashchat_accounts', JSON.stringify(accounts));
    }

    function removeAccount(email){
      let accounts = JSON.parse(localStorage.getItem('flashchat_accounts') || '[]');
      accounts = accounts.filter(a => a.email !== email);
      localStorage.setItem('flashchat_accounts', JSON.stringify(accounts));
      loadSavedAccounts();
    }

    function quickLogin(email,password){
      $('loginEmail').value = email;
      $('loginPassword').value = password;
      login(new Event('submit'));
    }

    // ====== NAV ======
    function showAuthScreen(){
      $('authScreen').style.display = 'block';
      $('chatScreen').classList.remove('active');
      $('chatScreen').style.display = 'none';
    }

    function showChatScreen(){
      $('authScreen').style.display = 'none';
      $('chatScreen').style.display = '';
      $('chatScreen').classList.add('active');

      // reset panels
      $('sidebar').style.display = 'flex';
      $('chatArea').classList.remove('active');
      $('chatArea').style.display = window.innerWidth <= 768 ? 'none' : 'flex';

      $('emptyChat').style.display = 'flex';
      $('activeChat').classList.remove('active');

      renderChatList();
    }

    function closeChat(){
      const prevChat = currentChat;
      currentChat = null;
      currentChatType = null;
      currentChatData = null;

      // Stop listeners for messages + typing
      if(prevChat){
        database.ref(`messages/${prevChat}`).off();
        database.ref(`typing/${prevChat}`).off();
      }

      $('activeChat').classList.remove('active');
      $('emptyChat').style.display = 'flex';

      if(window.innerWidth <= 768){
        $('chatArea').classList.remove('active');
        $('chatArea').style.display = 'none';
        $('sidebar').style.display = 'flex';
      }
    }

    // ====== FIREBASE auth ======
    if('Notification' in window && Notification.permission === 'default'){
      Notification.requestPermission();
    }

    auth.onAuthStateChanged(async user => {
      if(user){
        currentUser = user;
        await loadUserData();
        await loadAllUsers();
        showChatScreen();
        updateOnlineStatus(true);
        setupPresenceOnDisconnect();
        loadAllChats();
        setupNotificationListener();
      } else {
        currentUser = null;
        currentUserData = null;
        showAuthScreen();
      }
    });

    async function login(e){
      e.preventDefault();
      const email = $('loginEmail').value.trim();
      const password = $('loginPassword').value;
      const save = $('saveAccount').checked;

      try{
        await auth.signInWithEmailAndPassword(email,password);
        if(save){
          const snap = await database.ref(`users/${auth.currentUser.uid}`).once('value');
          const userData = snap.val();
          saveAccount(email, password, userData?.name || email);
          loadSavedAccounts();
        }
      } catch(err){
        showAuthError(getErrorMessage(err.code));
      }
    }

    async function register(e){
      e.preventDefault();
      const name = $('registerName').value.trim();
      const email = $('registerEmail').value.trim();
      const password = $('registerPassword').value;
      if(!name) return showAuthError('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');

      try{
        const cred = await auth.createUserWithEmailAndPassword(email,password);
        await database.ref(`users/${cred.user.uid}`).set({
          name,
          nameLower: name.toLowerCase(),
          email,
          status: '–ü—Ä–∏–≤–µ—Ç! –Ø –∏—Å–ø–æ–ª—å–∑—É—é FlashChat',
          online: true,
          createdAt: firebase.database.ServerValue.TIMESTAMP
        });
        saveAccount(email,password,name);
        loadSavedAccounts();
      } catch(err){
        showAuthError(getErrorMessage(err.code));
      }
    }

    function logout(){
      updateOnlineStatus(false);
      auth.signOut();
      closeModal('profileModal');
    }

    async function loadUserData(){
      const snap = await database.ref(`users/${currentUser.uid}`).once('value');
      currentUserData = snap.val() || {};
    }

    async function loadAllUsers(){
      const snap = await database.ref('users').once('value');
      allUsers = snap.val() || {};
    }

    function updateOnlineStatus(status){
      if(!currentUser) return;
      database.ref(`users/${currentUser.uid}`).update({
        online: status,
        lastSeen: firebase.database.ServerValue.TIMESTAMP
      });
    }

    function setupPresenceOnDisconnect(){
      database.ref(`users/${currentUser.uid}/online`).onDisconnect().set(false);
      database.ref(`users/${currentUser.uid}/lastSeen`).onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
    }

    // ====== CHAT LIST ======
    function showChatTab(tab){
      currentTab = tab;
      ['all','private','groups','channels'].forEach(t => {
        const el = $('tab' + t.charAt(0).toUpperCase() + t.slice(1));
        el.classList.toggle('bg-violet-600', t === tab);
        el.classList.toggle('text-white', t === tab);
        el.classList.toggle('text-slate-400', t !== tab);
      });
      renderChatList();
    }

    function loadAllChats(){
      // prevent duplicates
      database.ref(`userChats/${currentUser.uid}`).off('value');

      database.ref(`userChats/${currentUser.uid}`).on('value', async snapshot => {
        const chats = snapshot.val() || {};
        const processed = new Set();
        const list = [];

        for(const [chatId, chatData] of Object.entries(chats)){
          if(processed.has(chatId)) continue;
          processed.add(chatId);

          try{
            let chatInfo = { id: chatId, ...chatData, unread:0 };

            // last message
            const msgSnap = await database.ref(`messages/${chatId}`).orderByChild('timestamp').limitToLast(1).once('value');
            const msgs = msgSnap.val();
            if(msgs){
              const lastMsg = Object.values(msgs)[0];
              chatInfo.lastMessage = lastMsg.text || (lastMsg.fileUrl ? 'üìé –§–∞–π–ª' : '');
              chatInfo.lastTime = lastMsg.timestamp;
              chatInfo.lastSenderId = lastMsg.senderId;
            }

            // unread count
            const unreadSnap = await database.ref(`messages/${chatId}`).orderByChild('timestamp').once('value');
            const allMsgs = unreadSnap.val() || {};
            let unread = 0;
            for(const msg of Object.values(allMsgs)){
              if(msg.senderId !== currentUser.uid && (!msg.readBy || !msg.readBy[currentUser.uid])) unread++;
            }
            chatInfo.unread = unread;
            unreadCounts[chatId] = unread;

            if(chatData.type === 'private'){
              const userData = allUsers[chatData.oderId];
              if(userData){
                chatInfo.name = userData.name;
                chatInfo.email = userData.email;
                chatInfo.online = userData.online;
                chatInfo.avatar = (userData.name || '?').charAt(0).toUpperCase();
              }
            } else {
              const snap = await database.ref(`${chatData.type}s/${chatId}`).once('value');
              const data = snap.val();
              if(data){
                chatInfo.name = data.name;
                chatInfo.avatar = (data.name || '?').charAt(0).toUpperCase();
                chatInfo.members = data.members;
                chatInfo.owner = data.owner;
                chatInfo.description = data.description;
              }
            }

            if(chatInfo.name) list.push(chatInfo);
          } catch(err){
            console.error('load chat err', err);
          }
        }

        list.sort((a,b) => (b.lastTime || 0) - (a.lastTime || 0));
        allChats = list;
        renderChatList();
      });
    }

    function renderChatList(){
      const container = $('chatList');
      let filtered = allChats;
      if(currentTab !== 'all'){
        const typeMap = { private:'private', groups:'group', channels:'channel' };
        filtered = allChats.filter(c => c.type === typeMap[currentTab]);
      }

      if(!filtered.length){
        container.innerHTML = '<div class="p-6 text-center text-slate-500">–ù–µ—Ç —á–∞—Ç–æ–≤</div>';
        return;
      }

      container.innerHTML = filtered.map(chat => {
        const isActive = currentChat === chat.id;
        const statusDot = (chat.type === 'private' && chat.online) ? 'bg-emerald-500' : 'bg-slate-500';
        const typeIcon = chat.type === 'group' ? 'üë•' : chat.type === 'channel' ? 'üì¢' : '';
        const unreadBadge = chat.unread > 0 ? `<div class="min-w-[20px] h-5 bg-sky-500 rounded-full text-xs flex items-center justify-center px-1">${chat.unread}</div>` : '';
        const lastMsgPrefix = chat.lastSenderId === currentUser?.uid ? '–í—ã: ' : '';
        const gradientClass = chat.type === 'group' ? 'gradient-green' : chat.type === 'channel' ? 'gradient-orange' : 'gradient-bg';
        const titleHtml = chat.type === 'private' ? getNameWithBadge(chat.name, chat.email) : escapeHtml(chat.name);

        return `
          <div class="flex items-center gap-3 p-3 cursor-pointer hover:bg-white/5 transition ${isActive ? 'bg-white/5' : ''}" onclick="openChat('${chat.id}','${chat.type}')">
            <div class="relative shrink-0">
              <div class="w-12 h-12 rounded-full ${gradientClass} grid place-items-center font-bold">${escapeHtml(chat.avatar || '?')}</div>
              ${chat.type === 'private' ? `<div class="absolute bottom-0 right-0 w-3.5 h-3.5 ${statusDot} rounded-full border-2" style="border-color: rgba(15,23,42,.9)"></div>` : ''}
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex justify-between items-center gap-2">
                <div class="font-medium truncate flex items-center gap-2">${typeIcon}<span class="truncate">${titleHtml}</span></div>
                <div class="text-xs text-slate-400 shrink-0">${formatTime(chat.lastTime)}</div>
              </div>
              <div class="flex justify-between items-center gap-2">
                <div class="text-sm text-slate-400 truncate">${escapeHtml(lastMsgPrefix + (chat.lastMessage || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'))}</div>
                ${unreadBadge}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Search
    function searchAll(){
      const query = $('searchInput').value.toLowerCase();
      const container = $('searchResults');
      if(!query){
        container.classList.add('hidden');
        container.innerHTML = '';
        return;
      }
      const results = allChats.filter(c => (c.name || '').toLowerCase().includes(query));
      if(!results.length){
        container.innerHTML = '<div class="p-3 text-center text-slate-500">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
      } else {
        container.innerHTML = results.map(chat => {
          const gradientClass = chat.type === 'group' ? 'gradient-green' : chat.type === 'channel' ? 'gradient-orange' : 'gradient-bg';
          const title = chat.type === 'private' ? getNameWithBadge(chat.name, chat.email) : escapeHtml(chat.name);
          return `
            <div class="flex items-center gap-3 p-3 hover:bg-white/5 cursor-pointer" onclick="openChat('${chat.id}','${chat.type}'); $('searchInput').value=''; $('searchResults').classList.add('hidden');">
              <div class="w-10 h-10 rounded-full ${gradientClass} grid place-items-center font-bold">${escapeHtml(chat.avatar || '?')}</div>
              <div class="font-medium truncate">${title}</div>
            </div>
          `;
        }).join('');
      }
      container.classList.remove('hidden');
    }

    // ====== OPEN CHAT ======
    async function openChat(chatId, type){
      // Stop previous listeners
      if(currentChat && currentChat !== chatId){
        database.ref(`messages/${currentChat}`).off();
        database.ref(`typing/${currentChat}`).off();
      }

      currentChat = chatId;
      currentChatType = type;

      // Mobile: switch panels
      if(window.innerWidth <= 768){
        $('sidebar').style.display = 'none';
        $('chatArea').style.display = 'flex';
        $('chatArea').classList.add('active');
      } else {
        $('chatArea').style.display = 'flex';
      }

      $('emptyChat').style.display = 'none';
      $('activeChat').classList.add('active');
      closeEmoji();

      if(type === 'private'){
        const chatData = allChats.find(c => c.id === chatId);
        if(chatData){
          currentChatData = chatData;
          $('chatAvatar').textContent = chatData.avatar || '?';
          $('chatAvatar').className = 'w-10 h-10 rounded-full gradient-bg flex items-center justify-center font-bold flex-shrink-0';
          $('chatName').innerHTML = getNameWithBadge(chatData.name, chatData.email);

          database.ref(`users/${chatData.oderId}`).off('value');
          database.ref(`users/${chatData.oderId}`).on('value', snap => {
            const u = snap.val();
            if(u) $('chatStatus').textContent = u.online ? '–í —Å–µ—Ç–∏' : `–ë—ã–ª(–∞) ${formatLastSeen(u.lastSeen)}`;
          });
        }
        $('chatHeaderActions').innerHTML = '';
      } else {
        const snap = await database.ref(`${type}s/${chatId}`).once('value');
        const data = snap.val();
        currentChatData = data;

        $('chatAvatar').textContent = (data?.name || '?').charAt(0).toUpperCase();
        $('chatAvatar').className = `w-10 h-10 rounded-full ${type === 'group' ? 'gradient-green' : 'gradient-orange'} flex items-center justify-content-center font-bold flex-shrink-0`;
        $('chatName').textContent = (type === 'group' ? 'üë• ' : 'üì¢ ') + (data?.name || '');

        const memberCount = Object.keys(data?.members || {}).length;
        $('chatStatus').textContent = type === 'group' ? `${memberCount} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤` : `${memberCount} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤`;

        const isOwner = data?.owner === currentUser.uid;
        $('chatHeaderActions').innerHTML = isOwner ? `
          <button class="icon-btn" onclick="showSettings('${chatId}','${type}')" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
          </button>
        ` : '';
      }

      // Channel restrictions
      const isChannel = type === 'channel';
      const isOwner = currentChatData?.owner === currentUser.uid;
      if(isChannel && !isOwner){
        $('messageInputArea').style.display = 'none';
        $('channelNotice').style.display = 'block';
      } else {
        $('messageInputArea').style.display = 'block';
        $('channelNotice').style.display = 'none';
      }

      loadMessages(chatId);
      setupTypingListener(chatId);
      markAsRead(chatId);
      renderChatList();

      requestAnimationFrame(() => {
        $('messagesContainer').scrollTop = $('messagesContainer').scrollHeight;
      });
    }

    // ====== MESSAGES ======
    function loadMessages(chatId){
      const container = $('messagesContainer');
      container.innerHTML = '';

      database.ref(`messages/${chatId}`).orderByChild('timestamp').off();
      database.ref(`messages/${chatId}`).orderByChild('timestamp').on('child_added', snap => {
        const msg = snap.val();
        const msgId = snap.key;
        addMessageToUI(msg, msgId);
      });

      database.ref(`messages/${chatId}`).on('child_changed', snap => {
        updateMessageUI(snap.val(), snap.key);
      });
    }

    function getReadIcon(msg){
      if(msg.readBy && Object.keys(msg.readBy).some(uid => uid !== currentUser.uid)){
        return '<svg class="w-4 h-4 text-sky-300" fill="currentColor" viewBox="0 0 24 24"><path d="M18 7l-1.41-1.41-6.34 6.34 1.41 1.41L18 7zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12-1.42-1.41zM.41 13.41L6 19l1.41-1.41L1.83 12 .41 13.41z"/></svg>';
      }
      return '<svg class="w-4 h-4 text-slate-300" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>';
    }

    function getReactionsHtml(msgId, msg){
      const reactions = msg.reactions || {};
      const list = Object.entries(reactions).reduce((acc, [emoji, users]) => {
        const count = Object.keys(users||{}).length;
        const hasOwn = !!(users && users[currentUser.uid]);
        if(count > 0) acc.push({emoji, count, hasOwn});
        return acc;
      }, []);

      if(!list.length) return '';

      return `
        <div class="flex flex-wrap gap-1 mt-2">
          ${list.map(r => `
            <button class="px-2 py-0.5 rounded-full text-xs border border-white/10 ${r.hasOwn ? 'bg-violet-600/30' : 'bg-white/5'} hover:bg-white/10" onclick="toggleReaction('${msgId}','${r.emoji}')">
              <span>${r.emoji}</span><span class="ml-1">${r.count}</span>
            </button>
          `).join('')}
        </div>
      `;
    }

    function addMessageToUI(msg, msgId){
      const container = $('messagesContainer');
      const isOwn = msg.senderId === currentUser.uid;

      let senderLine = '';
      if(!isOwn && currentChatType !== 'private'){
        const sender = allUsers[msg.senderId];
        senderLine = `<div class="sender-line">${getNameWithBadge(sender?.name || 'Unknown', sender?.email)}</div>`;
      }

      let content = '';
      if(msg.fileUrl){
        if(msg.fileType && msg.fileType.startsWith('image/')){
          content += `
            <div class="message-media mb-2">
              <img loading="lazy" src="${msg.fileUrl}" alt="image" onclick="viewImage('${msg.fileUrl}')" style="cursor:pointer" />
            </div>
          `;
        } else if(msg.fileType && msg.fileType.startsWith('video/')){
          content += `
            <div class="message-media mb-2">
              <video controls src="${msg.fileUrl}"></video>
            </div>
          `;
        } else {
          content += `
            <a href="${msg.fileUrl}" target="_blank" class="file-chip mb-2">
              <svg class="w-8 h-8 text-violet-300 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
              <div class="min-w-0">
                <div class="text-sm font-medium truncate">${escapeHtml(msg.fileName || '–§–∞–π–ª')}</div>
                <div class="text-xs text-slate-400">–û—Ç–∫—Ä—ã—Ç—å</div>
              </div>
            </a>
          `;
        }
      }

      if(msg.text){
        const captionClass = (msg.fileUrl && msg.fileType && (msg.fileType.startsWith('image/') || msg.fileType.startsWith('video/'))) ? 'text-sm leading-relaxed break-words media-caption' : 'text-sm leading-relaxed break-words';
        content += `<div class="${captionClass}">${escapeHtml(msg.text)}</div>`;
      }

      const reactionsHtml = getReactionsHtml(msgId, msg);

      const row = document.createElement('div');
      row.className = `message-row ${isOwn ? 'out' : 'in'} fade-in`;
      row.id = `msg-${msgId}`;

      row.innerHTML = `
        <div class="max-w-full">
          ${senderLine}
          <div class="bubble ${isOwn ? 'out' : 'in'}" oncontextmenu="showReactions(event,'${msgId}')" onclick="handleMessageTap(event,'${msgId}')">
            ${content}
            <div class="meta">
              <span class="time">${formatTime(msg.timestamp)}</span>
              ${isOwn ? getReadIcon(msg) : ''}
            </div>
            ${reactionsHtml}
          </div>
        </div>
      `;

      container.appendChild(row);
      const nearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 120;
      if(nearBottom) container.scrollTop = container.scrollHeight;
    }

    function updateMessageUI(msg, msgId){
      const el = document.getElementById(`msg-${msgId}`);
      if(!el) return;

      const bubble = el.querySelector('.bubble');
      if(!bubble) return;

      const existing = bubble.querySelector('.flex.flex-wrap');
      const reactionsHtml = getReactionsHtml(msgId, msg);
      if(reactionsHtml){
        if(existing){
          existing.outerHTML = reactionsHtml.trim();
        } else {
          bubble.insertAdjacentHTML('beforeend', reactionsHtml);
        }
      } else {
        if(existing) existing.remove();
      }

      const meta = bubble.querySelector('.meta');
      if(meta && msg.senderId === currentUser.uid){
        const icon = meta.querySelector('svg');
        if(icon) icon.outerHTML = getReadIcon(msg);
        else meta.insertAdjacentHTML('beforeend', getReadIcon(msg));
      }
    }

    // ====== REACTIONS ======
    let lastTap = 0;
    function handleMessageTap(e, msgId){
      const now = Date.now();
      if(now - lastTap < 280){
        showReactions(e, msgId);
      }
      lastTap = now;
    }

    function showReactions(e, msgId){
      e.preventDefault();
      currentMessageId = msgId;
      const picker = $('reactionsPicker');
      picker.classList.add('show');

      const rect = e.target.getBoundingClientRect();
      const w = 240;
      const left = Math.max(10, Math.min(rect.left, window.innerWidth - w - 10));
      const top = Math.max(10, rect.top - 58);
      picker.style.left = left + 'px';
      picker.style.top = top + 'px';

      setTimeout(() => {
        document.addEventListener('click', hideReactions, { once:true });
      }, 0);
    }

    function hideReactions(){
      $('reactionsPicker').classList.remove('show');
    }

    function addReaction(emoji){
      if(!currentMessageId || !currentChat) return;
      database.ref(`messages/${currentChat}/${currentMessageId}/reactions/${emoji}/${currentUser.uid}`).set(true);
      hideReactions();
    }

    function toggleReaction(msgId, emoji){
      database.ref(`messages/${currentChat}/${msgId}/reactions/${emoji}/${currentUser.uid}`).once('value', snap => {
        if(snap.exists()) snap.ref.remove();
        else snap.ref.set(true);
      });
    }

    // ====== TYPING ======
    function handleTyping(){
      if(!currentChat) return;
      database.ref(`typing/${currentChat}/${currentUser.uid}`).set(true);
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        database.ref(`typing/${currentChat}/${currentUser.uid}`).set(false);
      }, 1800);
    }

    function setupTypingListener(chatId){
      database.ref(`typing/${chatId}`).off();
      database.ref(`typing/${chatId}`).on('value', snap => {
        const map = snap.val() || {};
        const typers = Object.entries(map).filter(([uid, val]) => uid !== currentUser.uid && val);
        if(typers.length){
          $('typingText').textContent = currentChatType === 'private' ? '–ø–µ—á–∞—Ç–∞–µ—Ç...' : '–ø–µ—á–∞—Ç–∞—é—Ç...';
          $('typingIndicator').classList.remove('hidden');
        } else {
          $('typingIndicator').classList.add('hidden');
        }
      });
    }

    // ====== READ ======
    function markAsRead(chatId){
      database.ref(`messages/${chatId}`).once('value', snap => {
        const msgs = snap.val() || {};
        for(const [msgId, msg] of Object.entries(msgs)){
          if(msg.senderId !== currentUser.uid){
            database.ref(`messages/${chatId}/${msgId}/readBy/${currentUser.uid}`).set(true);
          }
        }
      });
      unreadCounts[chatId] = 0;
    }

    // ====== FILES ======
    function handleFileSelect(event){
      const file = event.target.files?.[0];
      if(!file) return;

      const maxSize = file.type.startsWith('image/') ? 32 * 1024 * 1024 : 10 * 1024 * 1024;
      if(file.size > maxSize){
        showToast('‚ö†Ô∏è','–û—à–∏–±–∫–∞', `–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. ${file.type.startsWith('image/') ? '32' : '10'}MB)`);
        event.target.value = '';
        return;
      }

      pendingFile = file;
      $('uploadPreview').classList.remove('hidden');

      const previewImage = $('uploadPreviewImage');
      const previewFile = $('uploadPreviewFile');

      if(file.type.startsWith('image/')){
        previewImage.classList.remove('hidden');
        previewFile.classList.add('hidden');
        previewImage.src = URL.createObjectURL(file);
      } else {
        previewImage.classList.add('hidden');
        previewFile.classList.remove('hidden');
        previewFile.style.display = 'flex';
        $('uploadFileName').textContent = file.name;
      }

      $('imageCaption').value = '';
      event.target.value = '';
    }

    function cancelUpload(){
      if(uploadTask){
        try{ uploadTask.cancel(); }catch(e){}
        uploadTask = null;
      }
      isUploading = false;
      pendingFile = null;
      $('uploadPreview').classList.add('hidden');
      $('uploadProgress').classList.add('hidden');
      $('uploadProgressBar').style.width = '0%';
      $('imageCaption').value = '';

      const img = $('uploadPreviewImage');
      if(img && img.src && img.src.startsWith('blob:')){
        try{ URL.revokeObjectURL(img.src); }catch(e){}
      }
    }

    async function uploadImageToImgBB(file){
      return new Promise((resolve, reject) => {
        const formData = new FormData();
        formData.append('image', file);
        formData.append('key', IMGBB_API_KEY);

        $('uploadProgress').classList.remove('hidden');
        $('uploadProgressBar').style.width = '0%';

        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'https://api.imgbb.com/1/upload');

        xhr.upload.onprogress = (e) => {
          if(e.lengthComputable){
            const p = (e.loaded / e.total) * 100;
            $('uploadProgressBar').style.width = p + '%';
          }
        };

        xhr.onload = () => {
          try{
            const data = JSON.parse(xhr.responseText);
            if(xhr.status === 200 && data.success){
              resolve(data.data.url);
            } else {
              reject(new Error(data?.error?.message || 'imgBB upload failed'));
            }
          } catch(err){
            reject(new Error('Failed to parse imgBB response'));
          }
        };

        xhr.onerror = () => reject(new Error('Network error'));
        xhr.send(formData);
      });
    }

    async function uploadFileToFirebase(file){
      return new Promise((resolve, reject) => {
        const fileName = `${Date.now()}_${String(file.name).replace(/[^a-zA-Z0-9._-]/g, '_')}`;
        const filePath = `uploads/${currentUser.uid}/${fileName}`;
        const ref = storage.ref(filePath);

        const metadata = {
          contentType: file.type,
          customMetadata: { uploadedBy: currentUser.uid, originalName: file.name }
        };

        $('uploadProgress').classList.remove('hidden');
        $('uploadProgressBar').style.width = '0%';

        uploadTask = ref.put(file, metadata);
        uploadTask.on('state_changed',
          s => {
            const p = (s.bytesTransferred / s.totalBytes) * 100;
            $('uploadProgressBar').style.width = p + '%';
          },
          err => reject(err),
          async () => {
            try{
              const url = await uploadTask.snapshot.ref.getDownloadURL();
              resolve(url);
            } catch(e){ reject(e); }
          }
        );
      });
    }

    async function uploadFile(file){
      if(file.type.startsWith('image/')){
        return await uploadImageToImgBB(file);
      }
      return await uploadFileToFirebase(file);
    }

    async function sendFileWithCaption(){
      if(!pendingFile || !currentChat) return;
      if(isUploading) return showToast('‚è≥','–ü–æ–¥–æ–∂–¥–∏—Ç–µ','–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...');

      isUploading = true;
      const caption = $('imageCaption').value.trim();

      let messageData = {
        senderId: currentUser.uid,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        readBy: { [currentUser.uid]: true }
      };
      if(caption) messageData.text = caption;

      try{
        const url = await uploadFile(pendingFile);
        messageData.fileUrl = url;
        messageData.fileName = pendingFile.name;
        messageData.fileType = pendingFile.type;

        await database.ref(`messages/${currentChat}`).push(messageData);
        await touchChatUpdatedAt(currentChat);

        showToast('‚úÖ','–£—Å–ø–µ—à–Ω–æ','–§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
      } catch(err){
        console.error(err);
        showToast('‚ùå','–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª');
      } finally {
        isUploading = false;
        cancelUpload();
      }
    }

    async function touchChatUpdatedAt(chatId){
      await database.ref(`userChats/${currentUser.uid}/${chatId}/updatedAt`).set(firebase.database.ServerValue.TIMESTAMP);
      if(currentChatType === 'private'){
        const chatData = allChats.find(c => c.id === chatId);
        if(chatData) await database.ref(`userChats/${chatData.oderId}/${chatId}/updatedAt`).set(firebase.database.ServerValue.TIMESTAMP);
      } else if(currentChatData?.members){
        const ids = Object.keys(currentChatData.members);
        await Promise.all(ids.filter(uid => uid !== currentUser.uid).map(uid => database.ref(`userChats/${uid}/${chatId}/updatedAt`).set(firebase.database.ServerValue.TIMESTAMP)));
      }
    }

    // ====== SEND MESSAGE ======
    async function sendMessage(e){
      e.preventDefault();
      if(isUploading) return showToast('‚è≥','–ü–æ–¥–æ–∂–¥–∏—Ç–µ','–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...');
      if(pendingFile) return sendFileWithCaption();

      const input = $('messageInput');
      const text = input.value.trim();
      if(!text || !currentChat) return;

      input.value = '';

      if(typingTimeout){
        clearTimeout(typingTimeout);
        database.ref(`typing/${currentChat}/${currentUser.uid}`).set(false);
      }

      const messageData = {
        senderId: currentUser.uid,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        readBy: { [currentUser.uid]: true },
        text
      };

      await database.ref(`messages/${currentChat}`).push(messageData);
      await touchChatUpdatedAt(currentChat);
      closeEmoji();
    }

    // ====== IMAGE VIEWER ======
    function viewImage(url){
      $('viewerImage').src = url;
      $('imageViewer').classList.add('show');
    }
    function closeImageViewer(){
      $('imageViewer').classList.remove('show');
      $('viewerImage').src = '';
    }

    // ====== FILE PICKER MENU ======
    function openFilePicker(){
      const wrap = document.createElement('div');
      wrap.id = 'filePickerModal';
      wrap.className = 'modal show';
      wrap.onclick = (e) => { if(e.target && e.target.id === 'filePickerModal') wrap.remove(); };

      wrap.innerHTML = `
        <div class="sheet bottom p-4">
          <h3 class="text-lg font-bold mb-4 text-center">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å</h3>
          <div class="space-y-2">
            <button class="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl" onclick="selectFileType('photo')">
              <div class="w-10 h-10 rounded-full grid place-items-center" style="background: linear-gradient(135deg,#3b82f6,#22d3ee)">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
              </div>
              <div class="text-left">
                <div class="font-medium">–§–æ—Ç–æ –∏–ª–∏ –í–∏–¥–µ–æ</div>
                <div class="text-xs text-slate-400">–§–æ—Ç–æ —á–µ—Ä–µ–∑ imgBB (–¥–æ 32MB)</div>
              </div>
            </button>

            <button class="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl" onclick="selectFileType('camera')">
              <div class="w-10 h-10 rounded-full grid place-items-center" style="background: linear-gradient(135deg,#22c55e,#34d399)">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
              </div>
              <div class="text-left">
                <div class="font-medium">–ö–∞–º–µ—Ä–∞</div>
                <div class="text-xs text-slate-400">–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</div>
              </div>
            </button>

            <button class="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl" onclick="selectFileType('document')">
              <div class="w-10 h-10 rounded-full grid place-items-center" style="background: linear-gradient(135deg,#fb923c,#fbbf24)">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
              </div>
              <div class="text-left">
                <div class="font-medium">–î–æ–∫—É–º–µ–Ω—Ç</div>
                <div class="text-xs text-slate-400">PDF, Word, Excel</div>
              </div>
            </button>
          </div>
          <button class="w-full mt-4 py-2 text-slate-400 hover:text-white" onclick="document.getElementById('filePickerModal')?.remove()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      `;

      document.body.appendChild(wrap);
    }

    function selectFileType(type){
      const input = $('fileInput');
      if(type === 'camera'){
        input.accept = 'image/*';
        input.capture = 'environment';
      } else if(type === 'photo'){
        input.accept = 'image/*,video/*';
        input.removeAttribute('capture');
      } else {
        input.accept = '.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar';
        input.removeAttribute('capture');
      }
      input.click();
      document.getElementById('filePickerModal')?.remove();
    }

    // ====== EMOJI PICKER ======
    let currentEmojiCategory = 'smileys';

    function toggleEmoji(){
      const picker = $('emojiPicker');
      const willShow = !picker.classList.contains('show');
      picker.classList.toggle('show');
      if(willShow){
        renderEmojiCategory(currentEmojiCategory);
      }
    }

    function closeEmoji(){
      $('emojiPicker').classList.remove('show');
    }

    function showEmojiCategory(cat){
      currentEmojiCategory = cat;
      ['smileys','gestures','animals','food','activities','travel','objects','symbols'].forEach(k => {
        const btn = $('emojiTab' + k.charAt(0).toUpperCase() + k.slice(1));
        btn.classList.toggle('active', k === cat);
      });
      renderEmojiCategory(cat);
    }

    function renderEmojiCategory(cat){
      const grid = $('emojiGrid');
      const list = EMOJI[cat] || [];
      grid.innerHTML = list.map(e => `<button type="button" class="emoji-btn" onclick="addEmoji('${e.replace(/'/g, "\\'")}')">${e}</button>`).join('');
    }

    function addEmoji(emoji){
      const input = $('messageInput');
      input.value += emoji;
      input.focus();
    }

    // ====== NOTIFICATIONS ======
    function setupNotificationListener(){
      database.ref(`userChats/${currentUser.uid}`).off('child_changed');
      database.ref(`userChats/${currentUser.uid}`).on('child_changed', async snap => {
        const chatId = snap.key;
        if(chatId === currentChat && document.visibilityState === 'visible') return;

        const msgSnap = await database.ref(`messages/${chatId}`).orderByChild('timestamp').limitToLast(1).once('value');
        const msgs = msgSnap.val();
        if(!msgs) return;

        const lastMsg = Object.values(msgs)[0];
        if(lastMsg.senderId === currentUser.uid) return;

        const senderName = allUsers[lastMsg.senderId]?.name || '–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ';
        const msgText = lastMsg.text || (lastMsg.fileUrl ? 'üìé –§–∞–π–ª' : '');

        showToast(senderName.charAt(0).toUpperCase(), senderName, msgText, chatId);

        if(Notification.permission === 'granted' && document.visibilityState !== 'visible'){
          try{ new Notification(senderName, { body: msgText }); }catch(e){}
        }
      });
    }

    // ====== CREATE / USERS ======
    function showCreateMenu(){ showModal('createMenuModal'); }

    function showNewPrivateChat(){
      closeModal('createMenuModal');
      $('userSearchInput').value = '';
      $('userSearchResults').innerHTML = '';
      renderUsersForChat();
      showModal('newPrivateChatModal');
    }

    function renderUsersForChat(){
      const container = $('userSearchResults');
      const users = Object.entries(allUsers).filter(([uid]) => uid !== currentUser.uid);
      const unique = new Map(users);
      const arr = Array.from(unique.entries());

      if(!arr.length){
        container.innerHTML = '<div class="p-4 text-center text-slate-500">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
        return;
      }

      container.innerHTML = arr.map(([uid, user]) => `
        <div class="flex items-center gap-3 p-3 hover:bg-white/5 cursor-pointer rounded-xl" onclick="startPrivateChat('${uid}')" data-uid="${uid}">
          <div class="w-10 h-10 rounded-full gradient-bg grid place-items-center font-bold">${escapeHtml((user?.name || '?').charAt(0).toUpperCase())}</div>
          <div class="min-w-0">
            <div class="font-medium truncate">${getNameWithBadge(user?.name || 'Unknown', user?.email)}</div>
            <div class="text-xs text-slate-400">${user?.online ? '–í —Å–µ—Ç–∏' : '–ù–µ –≤ —Å–µ—Ç–∏'}</div>
          </div>
        </div>
      `).join('');
    }

    function searchUsersForChat(){
      const q = $('userSearchInput').value.toLowerCase();
      document.querySelectorAll('#userSearchResults [data-uid]').forEach(item => {
        const name = item.querySelector('.font-medium')?.textContent.toLowerCase() || '';
        item.style.display = name.includes(q) ? '' : 'none';
      });
    }

    async function startPrivateChat(otherUserId){
      closeModal('newPrivateChatModal');
      const chatId = currentUser.uid < otherUserId ? `${currentUser.uid}_${otherUserId}` : `${otherUserId}_${currentUser.uid}`;

      await database.ref(`userChats/${currentUser.uid}/${chatId}`).set({
        type: 'private',
        oderId: otherUserId,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
      });
      await database.ref(`userChats/${otherUserId}/${chatId}`).set({
        type: 'private',
        oderId: currentUser.uid,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
      });

      setTimeout(() => openChat(chatId, 'private'), 150);
    }

    function showCreateGroup(){
      closeModal('createMenuModal');
      $('groupName').value = '';
      $('groupSearchInput').value = '';
      selectedGroupMembers = [];
      renderSelectedMembers();
      renderUsersForGroup();
      showModal('createGroupModal');
    }

    function renderUsersForGroup(){
      const container = $('groupSearchResults');
      const users = Object.entries(allUsers).filter(([uid]) => uid !== currentUser.uid);
      const unique = new Map(users);
      const arr = Array.from(unique.entries());

      if(!arr.length){
        container.innerHTML = '<div class="p-4 text-center text-slate-500">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
        return;
      }

      container.innerHTML = arr.map(([uid, user]) => {
        const selected = selectedGroupMembers.includes(uid);
        return `
          <div class="flex items-center gap-3 p-3 hover:bg-white/5 cursor-pointer rounded-xl ${selected ? 'bg-violet-600/15' : ''}" onclick="toggleGroupMember('${uid}')" data-uid="${uid}">
            <div class="w-10 h-10 rounded-full gradient-bg grid place-items-center font-bold">${escapeHtml((user?.name || '?').charAt(0).toUpperCase())}</div>
            <div class="flex-1 min-w-0">
              <div class="font-medium truncate">${getNameWithBadge(user?.name || 'Unknown', user?.email)}</div>
            </div>
            ${selected ? '<svg class="w-5 h-5 text-violet-300" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>' : ''}
          </div>
        `;
      }).join('');
    }

    function searchUsersForGroup(){
      const q = $('groupSearchInput').value.toLowerCase();
      document.querySelectorAll('#groupSearchResults [data-uid]').forEach(item => {
        const name = item.querySelector('.font-medium')?.textContent.toLowerCase() || '';
        item.style.display = name.includes(q) ? '' : 'none';
      });
    }

    function toggleGroupMember(uid){
      const i = selectedGroupMembers.indexOf(uid);
      if(i >= 0) selectedGroupMembers.splice(i,1);
      else selectedGroupMembers.push(uid);
      renderSelectedMembers();
      renderUsersForGroup();
    }

    function renderSelectedMembers(){
      const container = $('selectedMembers');
      if(!selectedGroupMembers.length){
        container.innerHTML = '';
        return;
      }
      container.innerHTML = selectedGroupMembers.map(uid => {
        const u = allUsers[uid];
        return `
          <div class="flex items-center gap-1 bg-violet-600/20 border border-white/10 rounded-full px-2 py-1">
            <span class="text-sm">${escapeHtml(u?.name || 'User')}</span>
            <button class="text-slate-300 hover:text-white" onclick="toggleGroupMember('${uid}')">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
        `;
      }).join('');
    }

    async function createGroup(){
      const name = $('groupName').value.trim();
      if(!name) return showToast('‚ö†Ô∏è','–û—à–∏–±–∫–∞','–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã');
      if(!selectedGroupMembers.length) return showToast('‚ö†Ô∏è','–û—à–∏–±–∫–∞','–î–æ–±–∞–≤—å—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤');

      try{
        const groupId = database.ref().child('groups').push().key;
        const members = { [currentUser.uid]: true };
        selectedGroupMembers.forEach(uid => members[uid] = true);

        const updates = {};
        updates[`groups/${groupId}`] = {
          name,
          owner: currentUser.uid,
          members,
          createdAt: firebase.database.ServerValue.TIMESTAMP
        };
        Object.keys(members).forEach(uid => {
          updates[`userChats/${uid}/${groupId}`] = { type:'group', updatedAt: firebase.database.ServerValue.TIMESTAMP };
        });

        await database.ref().update(updates);

        closeModal('createGroupModal');
        selectedGroupMembers = [];
        showToast('‚úÖ','–£—Å–ø–µ—à–Ω–æ','–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞');
        setTimeout(() => openChat(groupId,'group'), 150);
      } catch(err){
        console.error(err);
        showToast('‚ùå','–û—à–∏–±–∫–∞', err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É');
      }
    }

    function showCreateChannel(){
      closeModal('createMenuModal');
      $('channelName').value = '';
      $('channelDescription').value = '';
      showModal('createChannelModal');
    }

    async function createChannel(){
      const name = $('channelName').value.trim();
      const description = $('channelDescription').value.trim();
      if(!name) return showToast('‚ö†Ô∏è','–û—à–∏–±–∫–∞','–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞');

      try{
        const channelId = database.ref().child('channels').push().key;
        const updates = {};
        updates[`channels/${channelId}`] = {
          name,
          description,
          owner: currentUser.uid,
          members: { [currentUser.uid]: true },
          createdAt: firebase.database.ServerValue.TIMESTAMP
        };
        updates[`userChats/${currentUser.uid}/${channelId}`] = { type:'channel', updatedAt: firebase.database.ServerValue.TIMESTAMP };

        await database.ref().update(updates);

        closeModal('createChannelModal');
        showToast('‚úÖ','–£—Å–ø–µ—à–Ω–æ','–ö–∞–Ω–∞–ª —Å–æ–∑–¥–∞–Ω');
        setTimeout(() => openChat(channelId,'channel'), 150);
      } catch(err){
        console.error(err);
        showToast('‚ùå','–û—à–∏–±–∫–∞', err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª');
      }
    }

    // ====== ACCOUNT SWITCHER ======
    function showAccountSwitcher(){
      const accounts = JSON.parse(localStorage.getItem('flashchat_accounts') || '[]');
      const container = $('accountSwitcherList');

      container.innerHTML = accounts.map(acc => {
        const isCurrent = currentUser?.email === acc.email;
        return `
          <div class="flex items-center gap-3 p-3 rounded-xl border border-white/10 ${isCurrent ? 'bg-violet-600/15' : 'hover:bg-white/5 cursor-pointer'}" ${isCurrent ? '' : `onclick=\"switchAccount('${escapeHtml(acc.email)}','${escapeHtml(acc.password)}')\"`}>
            <div class="w-10 h-10 gradient-bg rounded-full grid place-items-center font-bold">${escapeHtml((acc.name||'?').charAt(0).toUpperCase())}</div>
            <div class="flex-1 min-w-0">
              <div class="font-medium truncate">${escapeHtml(acc.name || acc.email)}</div>
              <div class="text-xs text-slate-400 truncate">${escapeHtml(acc.email)}</div>
            </div>
            ${isCurrent ? '<span class="text-xs text-violet-300">–¢–µ–∫—É—â–∏–π</span>' : ''}
          </div>
        `;
      }).join('') || '<div class="p-4 text-center text-slate-500">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤</div>';

      showModal('accountSwitcherModal');
    }

    async function switchAccount(email, password){
      closeModal('accountSwitcherModal');
      await auth.signOut();
      await auth.signInWithEmailAndPassword(email, password);
    }

    function addNewAccount(){
      closeModal('accountSwitcherModal');
      auth.signOut();
    }

    // ====== PROFILE ======
    async function showProfile(){
      const snap = await database.ref(`users/${currentUser.uid}`).once('value');
      const user = snap.val() || {};

      $('profileAvatar').textContent = (user.name || '?').charAt(0).toUpperCase();
      $('profileNameDisplay').innerHTML = getNameWithBadge(user.name || 'User', currentUser.email);
      $('profileEmail').textContent = currentUser.email;
      $('newProfileName').value = user.name || '';
      $('newProfileStatus').value = user.status || '';

      showModal('profileModal');
    }

    async function updateProfile(e){
      e.preventDefault();
      const name = $('newProfileName').value.trim();
      const status = $('newProfileStatus').value.trim();
      if(!name) return;

      await database.ref(`users/${currentUser.uid}`).update({ name, status, nameLower: name.toLowerCase() });
      showToast('‚úì','–£—Å–ø–µ—à–Ω–æ','–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω');
      closeModal('profileModal');

      let accounts = JSON.parse(localStorage.getItem('flashchat_accounts') || '[]');
      accounts = accounts.map(a => a.email === currentUser.email ? { ...a, name } : a);
      localStorage.setItem('flashchat_accounts', JSON.stringify(accounts));
      loadSavedAccounts();

      await loadAllUsers();
      renderChatList();
    }

    // ====== SETTINGS (OWNER) ======
    async function showSettings(chatId, type){
      const snap = await database.ref(`${type}s/${chatId}`).once('value');
      const data = snap.val();
      if(!data || data.owner !== currentUser.uid){
        return showToast('‚ùå','–û—à–∏–±–∫–∞','–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
      }

      $('settingsModal').dataset.chatId = chatId;
      $('settingsModal').dataset.type = type;

      $('settingsTitle').textContent = type === 'group' ? '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä—É–ø–ø—ã' : '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–Ω–∞–ª–∞';
      $('settingsName').value = data.name || '';
      $('settingsDescription').value = data.description || '';
      $('deleteButtonText').textContent = type === 'group' ? '–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É' : '–£–¥–∞–ª–∏—Ç—å –∫–∞–Ω–∞–ª';

      $('settingsDescriptionBlock').style.display = type === 'channel' ? 'block' : 'none';

      const members = data.members || {};
      $('settingsMemberCount').textContent = Object.keys(members).length;

      const list = $('settingsMembersList');
      list.innerHTML = '';

      for(const uid of Object.keys(members)){
        const u = allUsers[uid];
        if(!u) continue;
        const isOwner = uid === data.owner;
        const isSelf = uid === currentUser.uid;

        list.innerHTML += `
          <div class="flex items-center gap-3 p-2 bg-white/5 border border-white/10 rounded-xl">
            <div class="w-8 h-8 rounded-full gradient-bg grid place-items-center font-bold text-sm">${escapeHtml((u.name || '?').charAt(0).toUpperCase())}</div>
            <div class="flex-1 min-w-0">
              <div class="font-medium text-sm truncate">${getNameWithBadge(u.name || 'Unknown', u.email)} ${isOwner ? '<span class="text-xs text-violet-300">(–≤–ª–∞–¥–µ–ª–µ—Ü)</span>' : ''}</div>
            </div>
            ${(!isSelf && !isOwner) ? `
              <button class="icon-btn" style="width:36px;height:36px" onclick="removeMember('${chatId}','${type}','${uid}')" title="–£–¥–∞–ª–∏—Ç—å">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            ` : ''}
          </div>
        `;
      }

      showModal('settingsModal');
    }

    async function saveSettings(){
      const chatId = $('settingsModal').dataset.chatId;
      const type = $('settingsModal').dataset.type;
      const name = $('settingsName').value.trim();
      const description = $('settingsDescription').value.trim();
      if(!name) return showToast('‚ö†Ô∏è','–û—à–∏–±–∫–∞','–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');

      const updates = { name };
      if(type === 'channel') updates.description = description;

      try{
        await database.ref(`${type}s/${chatId}`).update(updates);
        showToast('‚úÖ','–£—Å–ø–µ—à–Ω–æ','–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        closeModal('settingsModal');

        await loadAllUsers();
      } catch(err){
        console.error(err);
        showToast('‚ùå','–û—à–∏–±–∫–∞', err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å');
      }
    }

    async function removeMember(chatId, type, uid){
      if(!confirm('–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞?')) return;
      try{
        await database.ref(`${type}s/${chatId}/members/${uid}`).remove();
        await database.ref(`userChats/${uid}/${chatId}`).remove();
        showToast('‚úÖ','–£—Å–ø–µ—à–Ω–æ','–£—á–∞—Å—Ç–Ω–∏–∫ —É–¥–∞–ª–µ–Ω');
        showSettings(chatId, type);
      } catch(err){
        console.error(err);
        showToast('‚ùå','–û—à–∏–±–∫–∞', err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å');
      }
    }

    async function deleteGroupOrChannel(){
      const chatId = $('settingsModal').dataset.chatId;
      const type = $('settingsModal').dataset.type;
      const typeName = type === 'group' ? '–≥—Ä—É–ø–ø—É' : '–∫–∞–Ω–∞–ª';
      if(!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${typeName}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) return;

      try{
        const snap = await database.ref(`${type}s/${chatId}/members`).once('value');
        const members = snap.val() || {};

        const updates = {};
        Object.keys(members).forEach(uid => {
          updates[`userChats/${uid}/${chatId}`] = null;
        });
        updates[`messages/${chatId}`] = null;
        updates[`${type}s/${chatId}`] = null;

        await database.ref().update(updates);

        closeModal('settingsModal');
        closeChat();
        showToast('‚úÖ','–£—Å–ø–µ—à–Ω–æ', type === 'group' ? '–ì—Ä—É–ø–ø–∞ —É–¥–∞–ª–µ–Ω–∞' : '–ö–∞–Ω–∞–ª —É–¥–∞–ª–µ–Ω');
      } catch(err){
        console.error(err);
        showToast('‚ùå','–û—à–∏–±–∫–∞', err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å');
      }
    }

    // ====== GLOBAL EVENTS ======
    document.addEventListener('visibilitychange', () => {
      if(currentUser) updateOnlineStatus(!document.hidden);
      if(!document.hidden && currentChat) markAsRead(currentChat);
    });

    window.addEventListener('resize', () => {
      if(!$('chatScreen').classList.contains('active')) return;

      if(window.innerWidth <= 768){
        if(currentChat){
          $('sidebar').style.display = 'none';
          $('chatArea').style.display = 'flex';
          $('chatArea').classList.add('active');
        } else {
          $('sidebar').style.display = 'flex';
          $('chatArea').style.display = 'none';
          $('chatArea').classList.remove('active');
        }
      } else {
        $('sidebar').style.display = 'flex';
        $('chatArea').style.display = 'flex';
        $('chatArea').classList.remove('active');
      }
    });

    document.addEventListener('keydown', (e) => {
      if(e.key === 'Escape'){
        ['createMenuModal','newPrivateChatModal','createGroupModal','createChannelModal','accountSwitcherModal','profileModal','settingsModal'].forEach(id => closeModal(id));
        closeImageViewer();
        $('reactionsPicker').classList.remove('show');
        closeEmoji();
      }
    });

    // Close emoji picker on outside click (Telegram-like)
    document.addEventListener('click', (e) => {
      const picker = $('emojiPicker');
      if(!picker.classList.contains('show')) return;

      const inputArea = $('messageInputArea');
      if(inputArea && inputArea.contains(e.target)) return;

      closeEmoji();
    });

    // ====== INIT ======
    loadSavedAccounts();
    renderEmojiCategory('smileys');
  </script>
</body>
</html>